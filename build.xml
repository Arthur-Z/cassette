<?xml version="1.0"?>
<Project DefaultTargets="Default" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">    
    <UsingTask AssemblyFile="tools\xunit.runner.msbuild.dll" TaskName="Xunit.Runner.MSBuild.xunit" />
    <UsingTask TaskName="GetAssemblyInformationalVersion" 
        TaskFactory="CodeTaskFactory" 
        AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll" >
        <ParameterGroup>
            <Assembly ParameterType="System.String" Required="true" />
            <Version ParameterType="System.String" Output="true" />
        </ParameterGroup>
        <Task>
            <Code Type="Fragment" Language="cs">
              var version = System.Diagnostics.FileVersionInfo.GetVersionInfo(@"C:\Development\Contrib\cassette\build\bin\lib40-Client\Cassette.dll");

              Version = version.ProductVersion;
            </Code>
        </Task>
    </UsingTask>
    <PropertyGroup>
        <Configuration>Release</Configuration>
    </PropertyGroup>

    <Target Name="Default" DependsOnTargets="Test;NugetPack"></Target>

    <Target Name="Build">
        <ItemGroup>
            <ClientProfile Include="src\Cassette\Cassette.csproj"/>
            <FullProfile Include="src\Cassette.Web\Cassette.Web.csproj"/>
            <FullProfile Include="src\Cassette.Views\Cassette.Views.csproj"/>
	        <NormalProject Include="src\Cassette.MSBuild\Cassette.MSBuild.csproj"/>
            <NormalProject Include="src\Cassette.UnitTests\Cassette.UnitTests.csproj"/>
            <NormalProject Include="src\Cassette.IntegrationTests\Cassette.IntegrationTests.csproj"/>
        </ItemGroup>
        <PropertyGroup>
            <OutputPath>..\..\build\bin</OutputPath>
        </PropertyGroup>

        <MSBuild Projects="@(ClientProfile)" 
            Targets="Clean;Build"
            Properties="Configuration=$(Configuration);TargetFrameworkVersion=v4.0;OutputPath=$(OutputPath)\lib40-Client"/>
        <MSBuild Projects="@(FullProfile)" 
            Targets="Clean;Build"
            Properties="Configuration=$(Configuration);TargetFrameworkVersion=v4.0;OutputPath=$(OutputPath)\lib40"/>
        <MSBuild Projects="@(ClientProfile)" 
            Targets="Clean;Build"
            Properties="Configuration=$(Configuration);TargetFrameworkVersion=v3.5;OutputPath=$(OutputPath)\lib35-Client"/>
        <MSBuild Projects="@(FullProfile)" 
            Targets="Clean;Build"
            Properties="Configuration=$(Configuration);TargetFrameworkVersion=v3.5;OutputPath=$(OutputPath)\lib35"/>

        <!-- .NET 4-only; might be good to build once then copy to lib40/lib35 dirs? -->
        <MSBuild Projects="@(NormalProject)" Targets="Clean;Build" Properties="Configuration=$(Configuration);OutputPath=$(OutputPath)\lib35"/>
        <MSBuild Projects="@(NormalProject)" Targets="Clean;Build" Properties="Configuration=$(Configuration);OutputPath=$(OutputPath)\lib40"/>
    </Target>

    <Target Name="Test" DependsOnTargets="Build">
        <!-- Run tests against 4.0 and 3.5 assemblies -->
        <xunit Assembly="build\bin\lib40\Cassette.UnitTests.dll" />
        <xunit Assembly="build\bin\lib40\Cassette.IntegrationTests.dll" />
        <xunit Assembly="build\bin\lib35\Cassette.UnitTests.dll" />
        <xunit Assembly="build\bin\lib35\Cassette.IntegrationTests.dll" />
    </Target>

    <Target Name="NugetPack" DependsOnTargets="Build">
        <ItemGroup>
            <Nuspec Include="src\Cassette\Cassette.nuspec"/>
            <Nuspec Include="src\Cassette.Views\Cassette.Views.nuspec"/>
            <Nuspec Include="src\Cassette.Web\Cassette.Web.nuspec"/>
        </ItemGroup>
        <PropertyGroup>
            <OutputDir>build\nuget</OutputDir>
        </PropertyGroup>
        <GetAssemblyInformationalVersion Assembly="build\bin\lib40-client\Cassette.dll">
            <Output PropertyName="Version" TaskParameter="Version" />
        </GetAssemblyInformationalVersion>
        <Message Text="Building Nuget packages for v$(Version)" />
        <MakeDir Directories="$(OutputDir)"/>
        <Exec Command="nuget pack %(Nuspec.Identity) -Version $(Version) -Symbols -OutputDirectory $(OutputDir)"/>
        <!-- The Cassette.MSBuild package is slightly different (-Tool, no symbols and -NoPackageAnalysis to avoid warning about DLLs in the Tools directory). -->
        <Exec Command="nuget pack src\Cassette.MSBuild\Cassette.MSBuild.nuspec -Version $(Version) -Tool -OutputDirectory $(OutputDir) -Prop Configuration=$(Configuration) -NoPackageAnalysis"/>
    </Target>

    <Target Name="NugetPush" DependsOnTargets="NugetPack">
        <ItemGroup>
            <Packages Include="build\nuget\*.nupkg" Exclude="build\nuget\*.symbols.nupkg"/>
        </ItemGroup>
        <Exec Command="nuget push %(Packages.Identity)" />
    </Target>
    
</Project>